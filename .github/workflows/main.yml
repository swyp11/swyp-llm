name: Docker Compose ê¸°ë°˜ AI FastAPI ì•± ë°°í¬

on:
  push:
    branches:
      - prod

permissions:
  contents: read

jobs:
  build-and-push:
    name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
    runs-on: ubuntu-latest

    steps:
      - name: GitHub ë ˆí¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: DockerHub ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Docker Buildx ì„¤ì •
        uses: docker/setup-buildx-action@v3

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/wedding-dress-ai-api:latest

  deploy-to-server:
    name: ì„œë²„ì— Docker Composeë¡œ ë°°í¬
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: GitHub ë ˆí¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ (ë°°í¬ìš©)
        uses: actions/checkout@v4

      - name: ì„œë²„ ë°°í¬ (ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ ë° ì¬ì‹œì‘)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          script: |
            cd /root

            echo "ğŸ”§ .env-ai íŒŒì¼ ìƒì„±/ì—…ë°ì´íŠ¸"
            cat > .env-ai << EOF
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            DB_HOST=${{ secrets.DB_HOST }}
            DB_PORT=${{ secrets.DB_PORT }}
            DB_NAME=${{ secrets.DB_NAME }}
            DB_USERNAME=${{ secrets.DB_USERNAME }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            APP_HOST=0.0.0.0
            APP_PORT=8000
            CACHE_TTL=${{ secrets.CACHE_TTL }}
            EOF

            echo "ğŸ“¥ ìµœì‹  ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ"
            docker pull ${{ secrets.DOCKER_USERNAME }}/wedding-dress-ai-api:latest

            echo "ğŸ”„ FastAPI ì»¨í…Œì´ë„ˆë§Œ ì¬ì‹œì‘"
            docker compose up -d --no-deps ai-api

            echo "ğŸ—‘ï¸ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì •ë¦¬"
            docker image prune -f || true

            echo "â³ ì„œë¹„ìŠ¤ ì¤€ë¹„ ëŒ€ê¸° (10ì´ˆ)"
            sleep 10

            echo "ğŸ” ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸"
            docker compose  ps

            echo "âœ… ë°°í¬ ì™„ë£Œ! FastAPI ì„œë¹„ìŠ¤ ë¡œê·¸:"
            docker compose logs --tail=50 ai-api